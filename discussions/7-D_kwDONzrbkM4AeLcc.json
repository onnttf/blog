{"id":"D_kwDONzrbkM4AeLcc","title":"WKWebView å®æˆ˜æŒ‡å—","body":"`WKWebView` æ˜¯è‹¹æœæä¾›çš„ç°ä»£åŒ–ç½‘é¡µæµè§ˆæ§ä»¶ï¼Œç”¨äºåœ¨ `iOS` åº”ç”¨ä¸­å±•ç¤ºç½‘é¡µå†…å®¹ã€‚å®ƒä» `iOS 8` å¼€å§‹æ”¯æŒä½¿ç”¨ã€‚\r\n\r\n## ä¸ºä»€ä¹ˆé€‰æ‹© `WKWebView`\r\n\r\nç›¸æ¯”äºä¼ ç»Ÿçš„ `UIWebView`ï¼Œ`WKWebView` å…·æœ‰ä»¥ä¸‹æ˜¾è‘—ä¼˜åŠ¿ï¼š\r\n\r\n1. å“è¶Šçš„æ€§èƒ½è¡¨ç°å’Œç¨³å®šæ€§\r\n2. æ˜¾è‘—é™ä½å†…å­˜å ç”¨\r\n3. å®Œæ•´æ”¯æŒç°ä»£ `HTML5` ç‰¹æ€§\r\n4. æµç•…çš„ `60fps` æ¸²æŸ“å’ŒåŸç”Ÿæ‰‹åŠ¿æ”¯æŒ\r\n5. ä¸°å¯Œçš„ä»£ç†æ–¹æ³•ï¼Œæä¾›æ›´å¼ºå¤§çš„æ§åˆ¶èƒ½åŠ›\r\n6. æ”¯æŒè¿›ç¨‹é—´é€šä¿¡ï¼Œæ›´å®‰å…¨å¯é \r\n\r\næ›´å¤šæŠ€æœ¯ç»†èŠ‚å¯ä»¥æŸ¥çœ‹ [WebKit å®˜æ–¹æ–‡æ¡£](https://developer.apple.com/documentation/webkit)\r\n\r\n## åŸºæœ¬ä½¿ç”¨\r\n\r\n### å¼•å…¥æ¡†æ¶\r\n\r\né¦–å…ˆéœ€è¦å¯¼å…¥ `WebKit` æ¡†æ¶ï¼š\r\n\r\n```objc\r\n#import <WebKit/WebKit.h>\r\n```\r\n\r\n### åˆ›å»ºå’Œé…ç½® WKWebView\r\n\r\n```objc\r\n// åˆ›å»º WKUserContentController ç”¨äº JS äº¤äº’\r\nWKUserContentController *userContentController = [[WKUserContentController alloc] init];\r\n\r\n// æ³¨å…¥ cookies\r\nNSString *js = @\"document.cookie='user=zhangpeng'\";\r\nWKUserScript *cookieScript = [[WKUserScript alloc] initWithSource:js\r\n                                                    injectionTime:WKUserScriptInjectionTimeAtDocumentStart\r\n                                                 forMainFrameOnly:NO];\r\n[userContentController addUserScript:cookieScript];\r\n\r\n// é…ç½® WKWebView\r\nWKWebViewConfiguration *config = [[WKWebViewConfiguration alloc] init];\r\nconfig.userContentController = userContentController;\r\n_config = config;\r\n\r\n// æ³¨å†Œ JS è°ƒç”¨å¤„ç†å™¨\r\nfor (NSString *scriptMessage in self.scriptMessages) {\r\n    [config.userContentController addScriptMessageHandler:self name:scriptMessage];\r\n}\r\n\r\n// åˆ›å»º WKWebView å®ä¾‹\r\nWKWebView *webView = [[WKWebView alloc] initWithFrame:CGRectMake(0, 0, kScreenW, kMainAreaHeightNoTab)\r\n                                        configuration:config];\r\nwebView.UIDelegate = self;        // UI äº¤äº’ä»£ç†\r\nwebView.navigationDelegate = self; // å¯¼èˆªä»£ç†\r\n[self.view addSubview:webView];\r\n_webView = webView;\r\n```\r\n\r\n## ä»£ç†æ–¹æ³•\r\n\r\n### WKNavigationDelegate\r\n\r\n`WKNavigationDelegate` æä¾›é¡µé¢åŠ è½½ç”Ÿå‘½å‘¨æœŸçš„å›è°ƒæ–¹æ³•ï¼š\r\n\r\n```objc\r\n// 1. å†³å®šæ˜¯å¦å…è®¸å¯¼èˆª\r\n- (void)webView:(WKWebView *)webView\r\ndecidePolicyForNavigationAction:(WKNavigationAction *)navigationAction\r\n  decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler {\r\n    NSLog(@\"%s\", __func__);\r\n    decisionHandler(WKNavigationActionPolicyAllow); // å…è®¸å¯¼èˆª\r\n}\r\n\r\n// 2. å¼€å§‹åŠ è½½\r\n- (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(WKNavigation *)navigation {\r\n    NSLog(@\"%s\", __func__);\r\n}\r\n\r\n// 3. æ”¶åˆ°å“åº”åå†³å®šæ˜¯å¦ç»§ç»­\r\n- (void)webView:(WKWebView *)webView\r\ndecidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse\r\n   decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler {\r\n    NSLog(@\"%s\", __func__);\r\n    decisionHandler(WKNavigationResponsePolicyAllow); // å…è®¸ç»§ç»­åŠ è½½\r\n}\r\n\r\n// 4. å¼€å§‹æ¥æ”¶å†…å®¹\r\n- (void)webView:(WKWebView *)webView didCommitNavigation:(WKNavigation *)navigation {\r\n    NSLog(@\"%s\", __func__);\r\n}\r\n\r\n// 5. åŠ è½½å®Œæˆ\r\n- (void)webView:(WKWebView *)webView didFinishNavigation:(WKNavigation *)navigation {\r\n    NSLog(@\"%s\", __func__);\r\n}\r\n\r\n// 6. åŠ è½½å¤±è´¥\r\n- (void)webView:(WKWebView *)webView\r\ndidFailNavigation:(WKNavigation *)navigation\r\n       withError:(NSError *)error {\r\n    NSLog(@\"%s\", __func__);\r\n}\r\n\r\n// 7. åŠ è½½å†…å®¹å¤±è´¥\r\n- (void)webView:(WKWebView *)webView didFailProvisionalNavigation:(WKNavigation *)navigation {\r\n    NSLog(@\"%s\", __func__);\r\n}\r\n```\r\n\r\nå…¶ä»–é‡è¦çš„ä»£ç†æ–¹æ³•ï¼š\r\n\r\n```objc\r\n// å¤„ç†é‡å®šå‘\r\n- (void)webView:(WKWebView *)webView\r\ndidReceiveServerRedirectForProvisionalNavigation:(WKNavigation *)navigation {\r\n    NSLog(@\"%s\", __func__);\r\n}\r\n\r\n// å¤„ç† SSL è¯ä¹¦è®¤è¯\r\n- (void)webView:(WKWebView *)webView\r\ndidReceiveAuthenticationChallenge:(NSURLAuthenticationChallenge *)challenge\r\ncompletionHandler:(void (^)(NSURLSessionAuthChallengeDisposition, NSURLCredential * _Nullable))completionHandler {\r\n    NSLog(@\"%s\", __func__);\r\n    // åˆ›å»ºå‡­è¯å¹¶ä¿¡ä»»æœåŠ¡å™¨è¯ä¹¦\r\n    NSURLCredential *credential = [[NSURLCredential alloc] initWithTrust:challenge.protectionSpace.serverTrust];\r\n    completionHandler(NSURLSessionAuthChallengeUseCredential, credential); // ä½¿ç”¨å‡­è¯ç»§ç»­è®¤è¯\r\n}\r\n\r\n// è¿›ç¨‹ç»ˆæ­¢å¤„ç†\r\n- (void)webViewWebContentProcessDidTerminate:(WKWebView *)webView {\r\n    NSLog(@\"%s\", __func__);\r\n}\r\n```\r\n\r\n### WKUIDelegate\r\n\r\n`WKUIDelegate` ä¸»è¦ç”¨äºå¤„ç† `JavaScript` çš„ `UI` äº¤äº’ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ `alert` å¼¹çª—ï¼š\r\n\r\n```objc\r\n// å¤„ç† JavaScript å¼¹çª—è­¦å‘Š\r\n- (void)webView:(WKWebView *)webView\r\nrunJavaScriptAlertPanelWithMessage:(NSString *)message\r\ninitiatedByFrame:(WKFrameInfo *)frame\r\ncompletionHandler:(void (^)(void))completionHandler {\r\n    // åˆ›å»ºè­¦å‘Šå¼¹çª—\r\n    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@\"æç¤º\"\r\n                                                                   message:message\r\n                                                            preferredStyle:UIAlertControllerStyleAlert];\r\n\r\n    // æ·»åŠ ç¡®å®šæŒ‰é’®\r\n    UIAlertAction *action = [UIAlertAction actionWithTitle:@\"ç¡®å®š\"\r\n                                                     style:UIAlertActionStyleDefault\r\n                                                   handler:nil];\r\n    [alert addAction:action];\r\n\r\n    // æ˜¾ç¤ºå¼¹çª—\r\n    [self presentViewController:alert animated:YES completion:nil];\r\n\r\n    // è°ƒç”¨å®Œæˆå¤„ç†\r\n    completionHandler();\r\n}\r\n```\r\n\r\nè¿˜æœ‰ä¸¤ä¸ªç”¨äºå¤„ç†ç¡®è®¤æ¡†å’Œè¾“å…¥æ¡†çš„æ–¹æ³•ï¼š\r\n\r\n```objc\r\n// å¤„ç† JavaScript ç¡®è®¤æ¡†\r\n- (void)webView:(WKWebView *)webView\r\nrunJavaScriptConfirmPanelWithMessage:(NSString *)message\r\ninitiatedByFrame:(WKFrameInfo *)frame\r\ncompletionHandler:(void (^)(BOOL result))completionHandler {\r\n    // æ˜¾ç¤ºç¡®è®¤æ¡†\r\n    UIAlertController *alert = [UIAlertController alertControllerWithTitle:@\"ç¡®è®¤\"\r\n                                                                   message:message\r\n                                                            preferredStyle:UIAlertControllerStyleAlert];\r\n\r\n    // ç¡®å®šæŒ‰é’®\r\n    UIAlertAction *confirmAction = [UIAlertAction actionWithTitle:@\"ç¡®å®š\"\r\n                                                           style:UIAlertActionStyleDefault\r\n                                                         handler:^(UIAlertAction * _Nonnull action) {\r\n                                                             completionHandler(YES); // ç¡®å®šæ—¶è¿”å› YES\r\n                                                         }];\r\n\r\n    // å–æ¶ˆæŒ‰é’®\r\n    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@\"å–æ¶ˆ\"\r\n                                                          style:UIAlertActionStyleCancel\r\n                                                        handler:^(UIAlertAction * _Nonnull action) {\r\n                                                            completionHandler(NO); // å–æ¶ˆæ—¶è¿”å› NO\r\n                                                        }];\r\n\r\n    [alert addAction:confirmAction];\r\n    [alert addAction:cancelAction];\r\n\r\n    // æ˜¾ç¤ºå¼¹çª—\r\n    [self presentViewController:alert animated:YES completion:nil];\r\n}\r\n\r\n// å¤„ç† JavaScript è¾“å…¥æ¡†\r\n- (void)webView:(WKWebView *)webView\r\nrunJavaScriptTextInputPanelWithPrompt:(NSString *)prompt\r\ndefaultText:(nullable NSString *)defaultText\r\ninitiatedByFrame:(WKFrameInfo *)frame\r\ncompletionHandler:(void (^)(NSString * _Nullable result))completionHandler {\r\n    // åˆ›å»ºè¾“å…¥æ¡†å¼¹çª—\r\n    UIAlertController *alert = [UIAlertController alertControllerWithTitle:nil\r\n                                                                   message:prompt\r\n                                                            preferredStyle:UIAlertControllerStyleAlert];\r\n\r\n    // æ·»åŠ æ–‡æœ¬è¾“å…¥æ¡†\r\n    [alert addTextFieldWithConfigurationHandler:^(UITextField * _Nonnull textField) {\r\n        textField.text = defaultText; // è®¾ç½®é»˜è®¤æ–‡æœ¬\r\n    }];\r\n\r\n    // ç¡®å®šæŒ‰é’®\r\n    UIAlertAction *confirmAction = [UIAlertAction actionWithTitle:@\"ç¡®å®š\"\r\n                                                           style:UIAlertActionStyleDefault\r\n                                                         handler:^(UIAlertAction * _Nonnull action) {\r\n                                                             // è¿”å›è¾“å…¥çš„æ–‡æœ¬\r\n                                                             completionHandler(alert.textFields.firstObject.text);\r\n                                                         }];\r\n\r\n    // å–æ¶ˆæŒ‰é’®\r\n    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@\"å–æ¶ˆ\"\r\n                                                          style:UIAlertActionStyleCancel\r\n                                                        handler:^(UIAlertAction * _Nonnull action) {\r\n                                                            // å–æ¶ˆæ—¶è¿”å› nil\r\n                                                            completionHandler(nil);\r\n                                                        }];\r\n\r\n    [alert addAction:confirmAction];\r\n    [alert addAction:cancelAction];\r\n\r\n    // æ˜¾ç¤ºå¼¹çª—\r\n    [self presentViewController:alert animated:YES completion:nil];\r\n}\r\n```\r\n\r\n## JavaScript äº¤äº’\r\n\r\n`WKWebView` æä¾›ä¸¤ç§ä¸ `JavaScript` äº¤äº’çš„æ–¹å¼ã€‚\r\n\r\n### MessageHandler æ–¹å¼\r\n\r\né€šè¿‡ `WKScriptMessageHandler` æ¥æ”¶ `JavaScript` æ¶ˆæ¯ï¼š\r\n\r\n```objc\r\n- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {\r\n    // å¤„ç†JSä¼ æ¥çš„æ¶ˆæ¯\r\n    // é€šè¿‡æŸ¥çœ‹ `WKScriptMessage`ï¼Œå¯ä»¥çœ‹åˆ° `name` å’Œ `body` ä¸¤ä¸ªå±æ€§ï¼Œ`name` å°±æ˜¯æ³¨å…¥çš„ `js` å¯¹è±¡åç§°ï¼Œ`body` å°±æ˜¯å‰ç«¯ä¼ ç»™æˆ‘ä»¬çš„å‚æ•°\r\n    if ([message.name isEqualToString:@\"test1\"]) {\r\n        NSLog(@\"æ”¶åˆ°test1æ¶ˆæ¯ï¼š%@\", message.body);\r\n    } else if ([message.name isEqualToString:@\"test2\"]) {\r\n        NSLog(@\"æ”¶åˆ°test2æ¶ˆæ¯ï¼š%@\", message.body);\r\n    }\r\n}\r\n```\r\n\r\n`JavaScript` è°ƒç”¨ç¤ºä¾‹ï¼š\r\n\r\n```javascript\r\nwindow.webkit.messageHandlers.test1.postMessage({ data: \"Hello\" });\r\n```\r\n\r\n### URL Schema æ–¹å¼\r\n\r\né€šè¿‡æ‹¦æˆªå¯¼èˆªè¯·æ±‚æ¥å¤„ç†è‡ªå®šä¹‰ `URL`ï¼š\r\n\r\n```objc\r\n- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler {\r\n    NSURL *url = navigationAction.request.URL;\r\n    if ([url.scheme isEqualToString:@\"myapp\"]) {\r\n        // å¤„ç†è‡ªå®šä¹‰URL\r\n        decisionHandler(WKNavigationActionPolicyCancel);\r\n        return;\r\n    }\r\n    decisionHandler(WKNavigationActionPolicyAllow);\r\n}\r\n```\r\n\r\n## æ³¨æ„äº‹é¡¹\r\n\r\n### Cookie å¤„ç†\r\n\r\n`WKWebView` çš„ `Cookie` éœ€è¦åŒæ—¶å¤„ç†ä¸¤ä¸ªæ–¹é¢ï¼š\r\n\r\n1. `JavaScript` ä¾§ï¼šé€šè¿‡æ³¨å…¥è„šæœ¬è®¾ç½®\r\n\r\n   ```objc\r\n   NSString *js = @\"document.cookie='key=value'\";\r\n   WKUserScript *script = [[WKUserScript alloc] initWithSource:js injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:NO];\r\n   [userContentController addUserScript:script];\r\n   ```\r\n\r\n2. `Native` è¯·æ±‚ï¼šæ·»åŠ  `Cookie` å¤´\r\n\r\n   ```objc\r\n   NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];\r\n   [request setValue:@\"key=value\" forHTTPHeaderField:@\"Cookie\"];\r\n   [webView loadRequest:request];\r\n   ```\r\n\r\néœ€è¦æ³¨æ„ `Cookie` æ³¨å…¥çš„ä¸¤ç§æ–¹å¼æœ‰ä¸åŒçš„ä½œç”¨èŒƒå›´ï¼š\r\n\r\n1. `JavaScript` æ³¨å…¥çš„ `Cookie`:\r\n\r\n   - å¯ä»¥é€šè¿‡ `document.cookie` åœ¨ `JavaScript` ä¸­è¯»å–\r\n   - åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­å¯ä»¥çœ‹åˆ°\r\n   - æœåŠ¡ç«¯ä»£ç  (å¦‚ `PHP`) æ— æ³•ç›´æ¥è¯»å–\r\n\r\n2. `NSMutableURLRequest` æ³¨å…¥çš„ `Cookie`:\r\n\r\n   - å¯ä»¥è¢«æœåŠ¡ç«¯ä»£ç  (å¦‚ `PHP` çš„ `$_COOKIE`) ç›´æ¥è¯»å–\r\n   - `JavaScript` æ— æ³•é€šè¿‡ `document.cookie` è®¿é—®\r\n   - åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­ä¸å¯è§\r\n\r\nå› æ­¤åœ¨å®é™…å¼€å‘ä¸­ï¼Œéœ€è¦æ ¹æ®å…·ä½“ä½¿ç”¨åœºæ™¯é€‰æ‹©åˆé€‚çš„æ³¨å…¥æ–¹å¼ã€‚å¦‚æœéœ€è¦åŒæ—¶æ”¯æŒå‰ç«¯å’Œåç«¯è®¿é—®ï¼Œåˆ™éœ€è¦åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æ–¹å¼æ³¨å…¥ `Cookie`ã€‚\r\n\r\n### å†…å­˜æ³„æ¼é—®é¢˜\r\n\r\n`WKWebView` å¯èƒ½é€ æˆå¾ªç¯å¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè§£å†³æ–¹æ¡ˆï¼š\r\n\r\n1. åˆ›å»ºå¼±å¼•ç”¨ä»£ç†ç±»ï¼š\r\n\r\n   ```objc\r\n   @interface WeakScriptMessageDelegate : NSObject\r\n   @property (nonatomic, weak) id<WKScriptMessageHandler> scriptDelegate;\r\n   @end\r\n   ```\r\n\r\n2. ä½¿ç”¨å¼±å¼•ç”¨ä»£ç†æ³¨å†Œæ¶ˆæ¯å¤„ç†ï¼š\r\n\r\n   ```objc\r\n   [config.userContentController addScriptMessageHandler:[[WeakScriptMessageDelegate alloc] initWithDelegate:self] name:scriptMessage];\r\n   ```\r\n\r\n3. åœ¨ dealloc ä¸­ç§»é™¤æ¶ˆæ¯å¤„ç†ï¼š\r\n\r\n   ```objc\r\n   [self.config.userContentController removeScriptMessageHandlerForName:scriptMessage];\r\n   ```\r\n\r\n## æœ€å\r\n\r\né€šè¿‡æœ¬æ–‡ï¼Œæˆ‘ä»¬è¯¦ç»†ä»‹ç»äº† `WKWebView` çš„ä»¥ä¸‹å‡ ä¸ªé‡è¦æ–¹é¢ï¼š\r\n\r\n1. åŸºæœ¬ä½¿ç”¨æ–¹æ³•å’Œé…ç½®é€‰é¡¹\r\n2. ä»£ç†å›è°ƒçš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ\r\n3. `JavaScript` äº¤äº’çš„ä¸¤ç§å®ç°æ–¹å¼\r\n4. `Cookie` å¤„ç†çš„æ³¨æ„äº‹é¡¹\r\n5. å†…å­˜ç®¡ç†çš„æœ€ä½³å®è·µ\r\n\r\n`WKWebView` ä½œä¸º `iOS` ç°ä»£åŒ–çš„ `Web` å®¹å™¨ï¼Œå…·æœ‰æ€§èƒ½ä¼˜è¶Šã€åŠŸèƒ½ä¸°å¯Œçš„ç‰¹ç‚¹ã€‚åˆç†ä½¿ç”¨å…¶æä¾›çš„å„é¡¹åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ„å»ºé«˜è´¨é‡çš„ `Web` æ··åˆåº”ç”¨ã€‚\r\n","number":7,"labels":{"nodes":[{"id":"LA_kwDONzrbkM8AAAAB4nYwyw","name":"iOS","url":"https://github.com/onnttf/blog/labels/iOS"}]},"category":{"id":"DIC_kwDONzrbkM4Cmnbf","name":"Show and tell","slug":"show-and-tell","emoji":":raised_hands:","emojiHTML":"<div>ğŸ™Œ</div>"},"author":{"login":"onnttf"},"authorAssociation":"OWNER","createdAt":"2017-12-03T08:00:00Z","updatedAt":"2025-02-03T15:33:22Z","repository":{"id":"R_kgDONzrbkA","url":"https://github.com/onnttf/blog"},"url":"https://github.com/onnttf/blog/discussions/7","jsonFilePath":"discussions/7-D_kwDONzrbkM4AeLcc.json","markdownFilePath":"2017/12/7-D_kwDONzrbkM4AeLcc.md"}
