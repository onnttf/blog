{"id":"D_kwDONzrbkM4AeNcT","title":"Go ç¼–ç¨‹å…¥é—¨ï¼šä»å®è·µä¸­å­¦ä¹ æ ¸å¿ƒæ¦‚å¿µ","body":"åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä»£ç å®æˆ˜ï¼Œæ·±å…¥å­¦ä¹  `Go` è¯­è¨€çš„æ ¸å¿ƒæ¦‚å¿µä¸æœ€ä½³å®è·µã€‚ä¸ä»…å¸¦ä½ å¤¯å®åŸºç¡€ï¼Œè¿˜å°†è®©ä½ åˆ‡èº«æ„Ÿå—åˆ° `Go` åœ¨é«˜æ•ˆå¹¶å‘å¤„ç†å’Œæ¨¡å—åŒ–è®¾è®¡ä¸Šçš„ç‹¬ç‰¹ä¼˜åŠ¿ï¼Œå¸®åŠ©ä½ è½»æ¾æŒæ¡è¿™ä¸€å¼ºå¤§çš„ç¼–ç¨‹è¯­è¨€ã€‚\r\n\r\n## å®Œæ•´ä»£ç \r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n    \"context\"\r\n    \"errors\"\r\n    \"fmt\"\r\n    \"math/rand\"\r\n    \"sync\"\r\n    \"time\"\r\n)\r\n\r\n// Bug è¡¨ç¤ºä¸€ä¸ªè½¯ä»¶ç¼ºé™·\r\ntype Bug struct {\r\n    ID          int\r\n    Priority    Priority\r\n    Type        BugType\r\n    Description string\r\n}\r\n\r\n// Priority è¡¨ç¤º bug çš„ä¼˜å…ˆçº§\r\ntype Priority int\r\n\r\nconst (\r\n    Low Priority = iota + 1\r\n    Medium\r\n    High\r\n    Critical\r\n)\r\n\r\nfunc (p Priority) String() string {\r\n    return [...]string{\"\", \"Low\", \"Medium\", \"High\", \"Critical\"}[p]\r\n}\r\n\r\n// BugType è¡¨ç¤º bug çš„ç±»å‹\r\ntype BugType string\r\n\r\nconst (\r\n    UIBug       BugType = \"UI\"\r\n    BackendBug  BugType = \"Backend\"\r\n    DatabaseBug BugType = \"Database\"\r\n    APIBug      BugType = \"API\"\r\n)\r\n\r\n// Result è¡¨ç¤ºå¤„ç† bug çš„ç»“æœ\r\ntype Result struct {\r\n    BugID int\r\n    Error error\r\n}\r\n\r\nvar (\r\n    ErrProcessingFailed = errors.New(\"å¤„ç†å¤±è´¥\")\r\n    ErrTimeout          = errors.New(\"å¤„ç†è¶…æ—¶\")\r\n)\r\n\r\n// BugProcessor å®šä¹‰äº†å¤„ç† bug çš„æ¥å£\r\ntype BugProcessor interface {\r\n    Process(context.Context, Bug) Result\r\n}\r\n\r\n// SimpleBugProcessor æ˜¯ BugProcessor çš„ä¸€ä¸ªç®€å•å®ç°\r\ntype SimpleBugProcessor struct{}\r\n\r\nfunc (p SimpleBugProcessor) Process(ctx context.Context, b Bug) Result {\r\n    // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´\r\n    processingTime := time.Duration(rand.Intn(10000)) * time.Millisecond\r\n    select {\r\n    case <-time.After(processingTime):\r\n        // æ¨¡æ‹Ÿå¤„ç†æˆåŠŸæˆ–å¤±è´¥\r\n        if rand.Float32() < 0.1 {\r\n            return Result{BugID: b.ID, Error: ErrProcessingFailed}\r\n        }\r\n        fmt.Printf(\"å¤„ç† %s bug #%dï¼ˆä¼˜å…ˆçº§ï¼š%sï¼‰ï¼š%s\\n\", b.Type, b.ID, b.Priority, b.Description)\r\n    return Result{BugID: b.ID, Error: nil}\r\n    case <-ctx.Done():\r\n        return Result{BugID: b.ID, Error: ErrTimeout}\r\n    }\r\n}\r\n\r\n// Notifier å®šä¹‰äº†å‘é€é€šçŸ¥çš„æ¥å£\r\ntype Notifier interface {\r\n    Notify(message string) error\r\n}\r\n\r\n// EmailNotifier é€šè¿‡é‚®ä»¶å‘é€é€šçŸ¥\r\ntype EmailNotifier struct {\r\n    To string\r\n}\r\n\r\nfunc (e EmailNotifier) Notify(message string) error {\r\n    fmt.Printf(\"å‘é€é‚®ä»¶åˆ° %sï¼š%s\\n\", e.To, message)\r\n    return nil\r\n}\r\n\r\n// BugManager ç®¡ç† bug å¤„ç†å’Œé€šçŸ¥\r\ntype BugManager struct {\r\n    processor BugProcessor\r\n    notifiers []Notifier\r\n}\r\n\r\nfunc NewBugManager(processor BugProcessor, notifiers ...Notifier) *BugManager {\r\n    return &BugManager{\r\n        processor: processor,\r\n        notifiers: notifiers,\r\n    }\r\n}\r\n\r\nfunc (bm *BugManager) ProcessBugs(ctx context.Context, bugs []Bug) (int, int) {\r\n    results := make(chan Result, len(bugs))\r\n    var wg sync.WaitGroup\r\n\r\n    for _, bug := range bugs {\r\n        wg.Add(1)\r\n        go func(b Bug) {\r\n            defer wg.Done()\r\n            results <- bm.processor.Process(ctx, b)\r\n        }(bug)\r\n    }\r\n\r\n    go func() {\r\n        wg.Wait()\r\n        close(results)\r\n    }()\r\n\r\n    successCount, failCount := 0, 0\r\n    for result := range results {\r\n        if result.Error != nil {\r\n            failCount++\r\n            fmt.Printf(\"Bug #%d å¤„ç†å¤±è´¥ï¼š%v\\n\", result.BugID, result.Error)\r\n        } else {\r\n            successCount++\r\n        }\r\n    }\r\n\r\n    return successCount, failCount\r\n}\r\n\r\nfunc (bm *BugManager) NotifyAll(message string) {\r\n    for _, notifier := range bm.notifiers {\r\n    if err := notifier.Notify(message); err != nil {\r\n        fmt.Printf(\"é€šçŸ¥å¤±è´¥ï¼š%v\\n\", err)\r\n    }\r\n    }\r\n}\r\n\r\nfunc generateBugs(n int) []Bug {\r\n    bugs := make([]Bug, n)\r\n    types := []BugType{UIBug, BackendBug, DatabaseBug, APIBug}\r\n    priorities := []Priority{Low, Medium, High, Critical}\r\n\r\n    for i := 0; i < n; i++ {\r\n        bugs[i] = Bug{\r\n            ID:          i + 1,\r\n            Priority:    priorities[rand.Intn(len(priorities))],\r\n            Type:        types[rand.Intn(len(types))],\r\n            Description: fmt.Sprintf(\"Bug %d æè¿°\", i+1),\r\n    }\r\n    }\r\n    return bugs\r\n}\r\n\r\n// bugTypeStats ç»Ÿè®¡ä¸åŒç±»å‹ bug çš„æ•°é‡\r\nfunc bugTypeStats(bugs []Bug) map[BugType]int {\r\n    stats := make(map[BugType]int)\r\n    for _, bug := range bugs {\r\n        stats[bug.Type]++\r\n    }\r\n    return stats\r\n}\r\n\r\nfunc main() {\r\n    rand.Seed(time.Now().UnixNano())\r\n\r\n    developer := \"å°æ˜\"\r\n    bugCount := 20\r\n\r\n    bugs := generateBugs(bugCount)\r\n\r\n    fmt.Printf(\"%s æœ‰ %d ä¸ª bug éœ€è¦å¤„ç†ï¼\\n\", developer, bugCount)\r\n\r\n    // æ˜¾ç¤º bug ç±»å‹ç»Ÿè®¡\r\n    stats := bugTypeStats(bugs)\r\n    fmt.Println(\"\\n==== Bug ç±»å‹ç»Ÿè®¡ ====\")\r\n    for bugType, count := range stats {\r\n        fmt.Printf(\"  %sï¼š%d\\n\", bugType, count)\r\n    }\r\n\r\n    manager := NewBugManager(\r\n        SimpleBugProcessor{},\r\n        EmailNotifier{To: \"xiaoming@example.com\"},\r\n    )\r\n\r\n    ctx, cancel := context.WithTimeout(context.Background(), 5*time.Second)\r\n    defer cancel()\r\n\r\n    fmt.Println(\"\\n==== å¼€å§‹å¤„ç† Bugs ====\")\r\n    successCount, failCount := manager.ProcessBugs(ctx, bugs)\r\n\r\n    fmt.Printf(\"\\nå¤„ç†ç»“æœç»Ÿè®¡ï¼š\\n\")\r\n    fmt.Printf(\"æˆåŠŸï¼š%d\\n\", successCount)\r\n    fmt.Printf(\"å¤±è´¥ï¼š%d\\n\", failCount)\r\n\r\n    manager.NotifyAll(fmt.Sprintf(\"Bug å¤„ç†å®Œæˆã€‚æˆåŠŸï¼š%dï¼Œå¤±è´¥ï¼š%d\", successCount, failCount))\r\n}\r\n```\r\n\r\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†é€æ­¥è§£æè¿™äº›åŠŸèƒ½çš„å®ç°ä»£ç ã€‚\r\n\r\n## ä»£ç ç»“æ„ä¸æ ¸å¿ƒåŠŸèƒ½è§£æ\r\n\r\nåœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œå®ç°äº† `Bug` çš„åˆ›å»ºã€ç»Ÿè®¡å’Œå¤„ç†ï¼Œä»¥åŠå‘é€é€šçŸ¥çš„åŠŸèƒ½ã€‚æ¶µç›–äº†å¤§éƒ¨åˆ†çš„ `Go` è¯­è¨€ç‰¹æ€§ã€‚\r\n\r\n### æ•°æ®ç»“æ„ä¸ç±»å‹å®šä¹‰\r\n\r\n- å®šä¹‰äº† `Bug`ã€`Priority` å’Œ `BugType` ç­‰åŸºæœ¬æ•°æ®ç»“æ„å’Œç±»å‹ï¼Œæå‡ä»£ç å¯è¯»æ€§ä¸ç±»å‹å®‰å…¨ï¼š\r\n\r\n  - `Bug` ç»“æ„ä½“å°è£…äº†æ¯ä¸ª `Bug` çš„ `ID`ã€ä¼˜å…ˆçº§ã€ç±»å‹ä»¥åŠæè¿°ä¿¡æ¯\r\n  - `Priority` ä½¿ç”¨è‡ªå®šä¹‰çš„æ•´æ•°ç±»å‹è¡¨ç¤ºï¼Œå¹¶é€šè¿‡å¸¸é‡è¿›è¡Œç­‰çº§åˆ’åˆ†ï¼ˆå¦‚ `Low`ã€`Medium`ã€`High`ã€`Critical`ï¼‰ã€‚åŒæ—¶å®ç°äº† `String` æ–¹æ³•ï¼Œä½¿å¾—åœ¨è¾“å‡ºæ—¶èƒ½å¤Ÿæ˜¾ç¤ºæ›´å…·å¯è¯»æ€§çš„ä¼˜å…ˆçº§åç§°\r\n  - `BugType` ä½¿ç”¨å­—ç¬¦ä¸²ç±»å‹ï¼Œå®šä¹‰äº† `Bug` çš„å››ç§å¸¸è§åˆ†ç±»ï¼š`UIBug`ã€`BackendBug`ã€`DatabaseBug` å’Œ `APIBug`\r\n\r\n- åˆ©ç”¨ `slice` å’Œ `map` çš„ç»„åˆï¼Œç®€åŒ–æ•°æ®çš„ç»„ç»‡ä¸ç®¡ç†\r\n\r\n### æ¥å£ä¸å®ç°\r\n\r\né¡¹ç›®é€šè¿‡ `BugProcessor` å’Œ `Notifier` æ¥å£è§£è€¦äº† `Bug` å¤„ç†è¿‡ç¨‹å’Œå¤„ç†ç»“æœçš„é€šçŸ¥æµç¨‹ã€‚\r\n\r\n- `BugProcessor` æ¥å£å®šä¹‰äº† `Process` æ–¹æ³•ï¼Œè¡¨ç¤ºå¦‚ä½•å¤„ç†ä¸€ä¸ª `Bug`\r\n\r\n  `SimpleBugProcessor` æ˜¯å…¶å®ç°ï¼Œæ¨¡æ‹Ÿäº†å¤„ç†æ—¶é—´ï¼Œå¹¶éšæœºæ¨¡æ‹Ÿå¤„ç†æˆåŠŸæˆ–å¤±è´¥ã€‚\r\n\r\n- `Notifier` æ¥å£åˆ™ç”¨äºé€šçŸ¥çš„å‘é€\r\n\r\n  `EmailNotifier` å®ç°äº†é€šè¿‡ç”µå­é‚®ä»¶å‘é€ `Bug` å¤„ç†ç»“æœçš„åŠŸèƒ½ã€‚\r\n\r\né€šè¿‡è¿™ç§æ¥å£ä¸å®ç°åˆ†ç¦»çš„è®¾è®¡ï¼Œå¯ä»¥è½»æ¾æ‰©å±•å¤„ç†é€»è¾‘å’Œé€šçŸ¥æ–¹å¼ã€‚\r\n\r\n### å¹¶å‘ä¸ä»»åŠ¡ç®¡ç†\r\n\r\nå¹¶å‘æ˜¯ `Go` è¯­è¨€çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨ `goroutines` æ¥å¹¶å‘å¤„ç† bugï¼Œ`sync.WaitGroup` åˆ™å¸®åŠ©æˆ‘ä»¬ç®¡ç†è¿™äº›å¹¶å‘ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹ã€‚\r\n\r\næ¯ä¸ª bug çš„å¤„ç†è¿‡ç¨‹éƒ½æ˜¯é€šè¿‡ `goroutine` æ¥æ‰§è¡Œï¼Œåˆ©ç”¨ `channel` æ¥ä¼ é€’å¤„ç†ç»“æœã€‚\r\n`sync.WaitGroup` ä¿è¯äº†ä¸»ç¨‹åºèƒ½å¤Ÿç­‰å¾…æ‰€æœ‰å¹¶å‘ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå†è¿›è¡Œç»Ÿè®¡å’Œåç»­æ“ä½œã€‚\r\n\r\n### ä¸Šä¸‹æ–‡ç®¡ç†\r\n\r\n`context` åŒ…çš„ä½¿ç”¨å±•ç¤ºäº†å¦‚ä½•åœ¨å¹¶å‘ç¨‹åºä¸­ç®¡ç†è¶…æ—¶ä¸å–æ¶ˆæ“ä½œã€‚åœ¨ `ProcessBugs` æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `context.WithTimeout` æ¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå½“ä»»åŠ¡å¤„ç†æ—¶é—´è¿‡é•¿æ—¶ä¼šè‡ªåŠ¨è§¦å‘å–æ¶ˆï¼Œé¿å…æ— é™åˆ¶çš„ç­‰å¾…ã€‚è¿™ç§è¶…æ—¶æ§åˆ¶æœºåˆ¶å¯ä»¥æœ‰æ•ˆé˜²æ­¢ç³»ç»Ÿç”±äºæŸä¸ªä»»åŠ¡é˜»å¡è€Œé™·å…¥å¡é¡¿ã€‚\r\n\r\n### é”™è¯¯å¤„ç†\r\n\r\né”™è¯¯å¤„ç†åœ¨ `Go` ç¼–ç¨‹ä¸­è‡³å…³é‡è¦ã€‚åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œå¤„ç†è¿‡ç¨‹ä¸­ä¼šè¿”å›è‡ªå®šä¹‰çš„é”™è¯¯ç±»å‹ï¼Œå¦‚ `ErrProcessingFailed`ï¼ˆå¤„ç†å¤±è´¥ï¼‰å’Œ `ErrTimeout`ï¼ˆå¤„ç†è¶…æ—¶ï¼‰ã€‚åœ¨ `ProcessBugs` æ–¹æ³•ä¸­ï¼Œæ ¹æ®ä¸åŒçš„é”™è¯¯ç±»å‹ï¼Œç¨‹åºè¾“å‡ºç›¸åº”çš„å¤±è´¥ä¿¡æ¯ï¼Œå¹¶è¿›è¡Œè®¡æ•°ï¼Œæœ€ç»ˆé€šè¿‡ `NotifyAll` æ–¹æ³•å‘é€é€šçŸ¥ï¼Œå‘ŠçŸ¥å¤„ç†ç»“æœã€‚\r\n\r\n### æ¨¡å—åŒ–è®¾è®¡ä¸æ‰©å±•æ€§\r\n\r\né¡¹ç›®ä¸­å„æ¨¡å—ä¹‹é—´é€šè¿‡æ¥å£ç›¸äº’è§£è€¦ï¼Œå…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾æ›¿æ¢ `SimpleBugProcessor` ä¸ºæ›´å¤æ‚çš„å¤„ç†é€»è¾‘ï¼Œæˆ–è€…é€šè¿‡å®ç°æ–°çš„ `Notifier`ï¼ˆå¦‚çŸ­ä¿¡é€šçŸ¥ï¼‰æ¥å¢åŠ é€šçŸ¥æ¸ é“ã€‚\r\n\r\nå„ä¸ªæ¨¡å—çš„èŒè´£å•ä¸€ä¸”æ˜ç¡®ï¼Œç¬¦åˆé¢å‘æ¥å£ç¼–ç¨‹çš„æ€æƒ³ï¼Œè¿™ä¸ä»…æå‡äº†ä»£ç çš„å¯è¯»æ€§ï¼Œè¿˜ä¸ºæ—¥åçš„ç»´æŠ¤ä¸æ‰©å±•æä¾›äº†ä¾¿åˆ©ã€‚\r\n\r\n## æ€»ç»“\r\n\r\né€šè¿‡ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬æ·±å…¥å®è·µäº† `Go` è¯­è¨€çš„æ ¸å¿ƒæ¦‚å¿µï¼ŒåŒ…æ‹¬æ•°æ®ç»“æ„è®¾è®¡ã€æ¥å£ä¸å®ç°çš„è§£è€¦ã€å¹¶å‘å¤„ç†ã€ä¸Šä¸‹æ–‡ç®¡ç†ä»¥åŠé”™è¯¯å¤„ç†ç­‰å†…å®¹ã€‚\r\n\r\nä»£ç å±•ç¤ºäº† `Go` åœ¨é«˜æ•ˆå¹¶å‘å¤„ç†å’Œæ¨¡å—åŒ–è®¾è®¡ä¸Šçš„ä¼˜åŠ¿ï¼š\r\n\r\n- ç»“æ„æ¸…æ™°\r\n- èŒè´£æ˜ç¡®\r\n- å…·å¤‡è‰¯å¥½çš„æ‰©å±•æ€§\r\n\r\nåœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™ç§è®¾è®¡ä¸ä»…æå‡äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œè¿˜ä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åŸºç¡€ï¼Œå……åˆ†ä½“ç°äº† `Go` è¯­è¨€çš„ç®€æ´ä¸é«˜æ•ˆã€‚\r\n","number":38,"labels":{"nodes":[]},"category":{"id":"DIC_kwDONzrbkM4Cmnbf","name":"Show and tell","slug":"show-and-tell","emoji":":raised_hands:","emojiHTML":"<div>ğŸ™Œ</div>"},"author":{"login":"onnttf"},"authorAssociation":"OWNER","createdAt":"2024-08-22T17:58:21Z","updatedAt":"2025-02-05T11:58:05Z","repository":{"id":"R_kgDONzrbkA","url":"https://github.com/onnttf/blog"},"url":"https://github.com/onnttf/blog/discussions/38","jsonFilePath":"discussions/38-D_kwDONzrbkM4AeNcT.json","markdownFilePath":"2024/08/38-D_kwDONzrbkM4AeNcT.md"}
