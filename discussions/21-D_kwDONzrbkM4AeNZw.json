{"id":"D_kwDONzrbkM4AeNZw","title":"å¦‚ä½•æ¸…ç† Git ä»“åº“","body":"## Git ä»“åº“ä½“ç§¯å¢é•¿çš„åŸå› \r\n\r\nGit é€šè¿‡ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿè®°å½•æ–‡ä»¶çš„æ¯ä¸€ä¸ªå˜æ›´ã€‚å³ä½¿åªä¿®æ”¹äº†æ–‡ä»¶ä¸­çš„ä¸€è¡Œå†…å®¹ï¼ŒGit ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ `blob` å¯¹è±¡æ¥å­˜å‚¨æ›´æ–°åçš„æ–‡ä»¶å†…å®¹ã€‚æ¯æ¬¡æäº¤éƒ½ä¼šç”Ÿæˆæ–°å¯¹è±¡ï¼Œå¯¼è‡´ä»“åº“ä½“ç§¯ä¸æ–­å¢åŠ ã€‚éšç€é¡¹ç›®å¼€å‘çš„æ·±å…¥ï¼Œè¿™äº›å¯¹è±¡ä¼šè¶Šæ¥è¶Šå¤šã€‚\r\n\r\nè™½ç„¶ Git ä¼šåœ¨ `git gc` æ‰“åŒ…æˆ– `git push` æ—¶è‡ªåŠ¨è¿›è¡Œæ‰“åŒ…å‹ç¼©ï¼Œå°† `blob` å¯¹è±¡åˆå¹¶æˆåŒ…æ–‡ä»¶å¹¶ä½¿ç”¨å¢é‡ç¼–ç åªä¿å­˜å·®å¼‚å†…å®¹ï¼Œä½†ä»“åº“ä½“ç§¯ä»ä¼šéšç€ä½¿ç”¨é€æ¸å¢é•¿ã€‚å› æ­¤éœ€è¦å®šæœŸæ¸…ç†æ¥ä¿æŒä»“åº“è½»é‡ã€‚\r\n\r\n## æ¸…ç†æ–¹æ³•\r\n\r\n### æ¸…ç†å¤§æ–‡ä»¶\r\n\r\nè¿™ç§æ–¹æ³•ä¸»è¦ç”¨äºæ¸…ç†å ç”¨ç©ºé—´è¾ƒå¤§æˆ–ä¸å†éœ€è¦çš„æ–‡ä»¶ï¼ˆä»¥ä¸‹ç§°ä¸ºå†—ä½™æ–‡ä»¶ï¼‰åŠå…¶æäº¤è®°å½•ã€‚**æ³¨æ„ï¼šä»¥ä¸‹æ“ä½œä¼šçœŸå®åˆ é™¤æ–‡ä»¶ï¼Œè¯·è°¨æ…æ“ä½œï¼**\r\n\r\n1. å®šä½å†—ä½™æ–‡ä»¶\r\n\r\n   ä½¿ç”¨ [git-rev-list](https://git-scm.com/docs/git-rev-list) å’Œ [git-verify-pack](https://git-scm.com/docs/git-verify-pack) å‘½ä»¤æŸ¥æ‰¾æœ€å ç©ºé—´çš„æ–‡ä»¶ï¼š\r\n\r\n   ```bash\r\n   git rev-list --objects --all | \\\r\n   grep \"$(git verify-pack -v .git/objects/pack/*.idx | \\\r\n   sort -k 3 -n | tail -5 | awk '{print $1}')\"\r\n   ```\r\n\r\n2. åˆ é™¤å†—ä½™æ–‡ä»¶\r\n\r\n   ä½¿ç”¨ [git-filter-branch](https://git-scm.com/docs/git-filter-branch) åˆ é™¤å†—ä½™æ–‡ä»¶ï¼š\r\n\r\n   ```bash\r\n   git filter-branch --force --index-filter \\\r\n   'git rm -r --cached --ignore-unmatch æ–‡ä»¶å' \\\r\n   --prune-empty -- --all\r\n   ```\r\n\r\n   **æ‰§è¡Œåˆ é™¤å‰åŠ¡å¿…ä»”ç»†æ£€æŸ¥æ–‡ä»¶åˆ—è¡¨ï¼**\r\n\r\n3. å½»åº•æ¸…ç†\r\n\r\n   æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å½»åº•æ¸…ç†ä»“åº“ï¼Œåˆ é™¤å¤‡ä»½å¼•ç”¨ã€è¿‡æœŸçš„ reflog è®°å½•ï¼Œå¹¶å¯¹ä»“åº“è¿›è¡Œåƒåœ¾å›æ”¶ï¼š\r\n\r\n   ```bash\r\n   # åˆ é™¤å¤‡ä»½çš„å¼•ç”¨\r\n   git for-each-ref --format='delete %(refname)' refs/original | git update-ref --stdin\r\n   # æ¸…ç†è¿‡æœŸçš„ reflog è®°å½•\r\n   git reflog expire --expire=now --all\r\n   # è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œæ¸…ç†ä¸å¯è¾¾å¯¹è±¡\r\n   git gc --prune=now\r\n   ```\r\n\r\n4. ç¡®è®¤æ— è¯¯åï¼Œæ¨é€æ›´æ–°åˆ°è¿œç¨‹ä»“åº“\r\n\r\n   ```bash\r\n   git push --force\r\n   ```\r\n\r\n### é‡ç½®ä»“åº“\r\n\r\nè¿™æ˜¯ä¸€ä¸ªå¿«é€Ÿä½†æ¿€è¿›çš„è§£å†³æ–¹æ¡ˆï¼Œä¼š**å®Œå…¨æ¸…é™¤ä»“åº“çš„æ‰€æœ‰å†å²è®°å½•**ã€‚ç”±äºæ“ä½œä¸å¯é€†ï¼Œå»ºè®®ä»…åœ¨ä»¥ä¸‹æƒ…å†µä½¿ç”¨ï¼š\r\n\r\n- ä»“åº“ä½“ç§¯è¿‡å¤§ä¸”å†å²è®°å½•ä¸å†é‡è¦\r\n- éœ€è¦å½»åº•æ¸…é™¤æ•æ„Ÿä¿¡æ¯\r\n- é‡æ–°å¼€å§‹ä¸€ä¸ªå¹²å‡€çš„ç‰ˆæœ¬å†å²\r\n\r\næ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š\r\n\r\n1. æ¸…ç†æ‰€æœ‰è¿œç¨‹åˆ†æ”¯\r\n\r\n   ```bash\r\n   # åˆ é™¤é™¤äº† master ä¹‹å¤–çš„æ‰€æœ‰è¿œç¨‹åˆ†æ”¯\r\n   git branch -r | grep origin | grep -v '>' | grep -v master | xargs -L1 | awk '{sub(/origin\\//,\"\");print}'| xargs git push origin --delete\r\n   ```\r\n\r\n2. é‡æ–°åˆå§‹åŒ–ä»“åº“\r\n\r\n   ```bash\r\n   # åˆ é™¤æ—§çš„ .git ç›®å½•å¹¶åˆå§‹åŒ–æ–°ä»“åº“\r\n   rm -rf .git\r\n   git init\r\n   git add .\r\n   git commit -m \"Initial commit: Reset repository\"\r\n   ```\r\n\r\n3. é‡æ–°å…³è”è¿œç¨‹ä»“åº“\r\n\r\n   ```bash\r\n   # æ·»åŠ è¿œç¨‹ä»“åº“åœ°å€å¹¶å¼ºåˆ¶æ¨é€\r\n   git remote add origin <ä»“åº“åœ°å€>\r\n   git push -f origin master\r\n   ```\r\n\r\n**æ³¨æ„ï¼š** æ­¤æ“ä½œä¼šæ°¸ä¹…åˆ é™¤æ‰€æœ‰æäº¤å†å²ã€åˆ†æ”¯ä¿¡æ¯å’Œæ ‡ç­¾ã€‚\r\n","number":21,"labels":{"nodes":[]},"category":{"id":"DIC_kwDONzrbkM4Cmnbf","name":"Show and tell","slug":"show-and-tell","emoji":":raised_hands:","emojiHTML":"<div>ğŸ™Œ</div>"},"author":{"login":"onnttf"},"authorAssociation":"OWNER","createdAt":"2020-07-28T08:00:00Z","updatedAt":"2025-02-05T11:00:43Z","repository":{"id":"R_kgDONzrbkA","url":"https://github.com/onnttf/blog"},"url":"https://github.com/onnttf/blog/discussions/21","jsonFilePath":"discussions/21-D_kwDONzrbkM4AeNZw.json","markdownFilePath":"2020/7/21-D_kwDONzrbkM4AeNZw.md"}
