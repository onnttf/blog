{"id":"D_kwDONzrbkM4AeLb6","title":"å¦‚ä½•åœ¨ iOS ç³»ç»Ÿä¸­è¯»å–å¸¦åŠ å¯†å°ç« çš„ PDF æ–‡ä»¶","body":"åœ¨ä¸ç”µå­ç­¾ç« å…¬å¸åˆä½œæ—¶ï¼Œæˆ‘ä»¬æ”¶åˆ°äº†ä¸€ä»½å¸¦æœ‰åŠ å¯†å°ç« çš„ `PDF` æ–‡ä»¶ã€‚åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæ— è®ºé€šè¿‡ `UIWebView` è¿˜æ˜¯ `WKWebView` æ‰“å¼€ï¼Œæ–‡ä»¶ä¸­çš„åŠ å¯†å°ç« éƒ½æ— æ³•æˆåŠŸå±•ç¤ºã€‚\r\n\r\nç»è¿‡ä¸æ–­åœ°è°ƒç ”ä¸å®è·µï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†è¿™ä¸€é—®é¢˜ã€‚ç°åœ¨å°†è§£å†³æ–¹æ¡ˆåˆ†äº«ç»™å¤§å®¶ã€‚\r\n\r\n## å®ç°æ­¥éª¤\r\n\r\n### å‡†å¤‡å·¥ä½œ\r\n\r\né¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰å‡ ä¸ªå¸¸ç”¨çš„å®ï¼Œä»¥ä¾¿åœ¨åç»­ä»£ç ä¸­ä½¿ç”¨ï¼Œæå‡ä»£ç çš„å¯è¯»æ€§å’Œç®€æ´æ€§ï¼š\r\n\r\n```objc\r\n#define kScreenW [UIScreen mainScreen].bounds.size.width\r\n#define kScreenH [UIScreen mainScreen].bounds.size.height\r\n\r\n#define DOCUMENTS_DIRECTORY [NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES) lastObject]\r\n```\r\n\r\n### æ·»åŠ  WKWebView\r\n\r\næˆ‘ä»¬ä½¿ç”¨ `WKWebView` æ¥åŠ è½½å’Œå±•ç¤º `PDF` æ–‡ä»¶ã€‚\r\n\r\n```objc\r\n#import <WebKit/WebKit.h>\r\n\r\nWKWebViewConfiguration *config = [[WKWebViewConfiguration alloc] init];\r\n\r\nWKUserContentController *wkUController = [[WKUserContentController alloc]init];\r\n\r\nconfig.userContentController = wkUController;\r\n\r\n// æ³¨å…¥ JS å¯¹è±¡ï¼Œåç§°ä¸º AppModel\r\n// å½“ JS é€šè¿‡ AppModel æ¥è°ƒç”¨æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ WKScriptMessageHandler ä»£ç†ä¸­æ¥æ”¶åˆ°\r\n// æ­¤å¤„æ˜¯ä¸ºäº†å¾—åˆ°PDFåŠ è½½å®Œæˆæˆ–å¤±è´¥çš„åé¦ˆ\r\n[config.userContentController addScriptMessageHandler:self name:@\"AppModel\"];\r\n\r\n// æ”¹å˜é¡µé¢å†…å®¹å®½åº¦ï¼Œé€‚é…å±å¹•å¤§å°\r\nNSString *js = @\"var meta = document.createElement('meta'); meta.setAttribute('name', 'viewport'); meta.setAttribute('content', 'width=device-width'); document.getElementsByTagName('head')[0].appendChild(meta);\";\r\n\r\nWKUserScript *wkUserScript = [[WKUserScript alloc] initWithSource:js injectionTime:WKUserScriptInjectionTimeAtDocumentEnd forMainFrameOnly:YES];\r\n[wkUController addUserScript:wkUserScript];\r\n\r\nWKWebView *webView = [[WKWebView alloc] initWithFrame:CGRectMake(0, 0, kScreenW, kScreenH - 64) configuration:config];\r\nwebView.backgroundColor = [UIColor whiteColor];\r\nwebView.UIDelegate = self;\r\nwebView.navigationDelegate = self;\r\n[self.view addSubview:webView];\r\n```\r\n\r\n### ä¸‹è½½ PDF æ–‡ä»¶\r\n\r\n```objc\r\nNSString *urlStr = @\"\";\r\n\r\nNSURLRequest *request = [NSURLRequest requestWithURL:[NSURL URLWithString:urlStr]];\r\nNSURLSession *session = [NSURLSession sharedSession];\r\n\r\nNSURLSessionDataTask *sessionDataTask = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {\r\n    NSLog(@\"ä»æœåŠ¡å™¨è·å–åˆ° pdf æ•°æ®\");\r\n    //å¯¹ä»æœåŠ¡å™¨è·å–åˆ°çš„æ•°æ® data è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼š\r\n    dispatch_async(dispatch_get_main_queue(), ^{\r\n        NSString *path = [DOCUMENTS_DIRECTORY stringByAppendingPathComponent:@\"contract.pdf\"];\r\n        NSFileManager *fm = [NSFileManager defaultManager];\r\n        if ([fm fileExistsAtPath:path]) {\r\n            [fm removeItemAtPath:path error:nil];\r\n        }\r\n        BOOL success =  [data writeToFile:path atomically:YES];\r\n        if (success) {\r\n            NSLog(@\"ä¿å­˜æˆåŠŸ\");\r\n            NSURL *baseURL = [NSURL fileURLWithPath:[self getHtmlBasePath]];\r\n            NSString *path = [self getHtmlPath];\r\n            NSString *htmlStr = [NSString stringWithContentsOfFile:path encoding:NSUTF8StringEncoding error:nil];\r\n\r\n            [self.webView loadHTMLString:htmlStr baseURL:baseURL];\r\n        }\r\n    });\r\n}];\r\n[sessionDataTask resume];\r\n```\r\n\r\n### åŠ è½½ `PDF` æ–‡ä»¶\r\n\r\n```objc\r\n- (void)webView:(WKWebView *)webView didFinishNavigation:(WKNavigation *)navigation {\r\n    [self loadPDF];\r\n}\r\n\r\n- (void)loadPDF {\r\n    NSString *path = [DOCUMENTS_DIRECTORY stringByAppendingPathComponent:@\"contract.pdf\"];\r\n    NSData *data = [NSData dataWithContentsOfFile:path options:NSDataReadingMappedAlways error:nil];\r\n\r\n    NSString *paraStr = [data base64EncodedStringWithOptions:NSDataBase64EncodingEndLineWithCarriageReturn];\r\n    NSString *js = [NSString stringWithFormat:@\"loadMyJS('%@')\",paraStr];\r\n\r\n    [self.webView evaluateJavaScript:js completionHandler:^(id _Nullable response, NSError * _Nullable error) {\r\n        if (error) {\r\n            NSLog(@\"%@\", error);\r\n            NSLog(@\"å½“å‰æ‰‹æœºç³»ç»Ÿç‰ˆæœ¬è¾ƒä½ï¼Œä¸æ”¯æŒæŸ¥çœ‹ï¼Œè¯·å‡çº§ç³»ç»Ÿæˆ–è€…åˆ° PC ç«¯æŸ¥çœ‹ã€‚\");\r\n        }\r\n    }];\r\n}\r\n```\r\n\r\n### ä¸ js è¿›è¡Œäº¤äº’\r\n\r\nä¸ `js` çš„äº¤äº’ä¸»è¦æ˜¯ä¸ºäº†åœ¨æ§åˆ¶å™¨ä¸­è·å– `PDF` æ–‡ä»¶çš„åŠ è½½çŠ¶æ€ã€‚é€šè¿‡è¿™ç§äº¤äº’ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥ `PDF` æ–‡ä»¶æ˜¯å¦åŠ è½½å®Œæˆï¼Œæˆ–è€…åœ¨åŠ è½½å¤±è´¥æ—¶å¤„ç†é”™è¯¯æç¤ºã€‚\r\n\r\nåœ¨ `js` ä»£ç ä¸­ï¼Œå½“ `PDF` æ–‡ä»¶åŠ è½½å®Œæˆæˆ–å¤±è´¥æ—¶ï¼Œè°ƒç”¨å·²æ³¨å†Œçš„æ¥å£å°†çŠ¶æ€ä¼ é€’ç»™åŸç”Ÿä»£ç ã€‚\r\n\r\nç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š\r\n\r\n```js\r\nfunction handlePages(page) {\r\n  //create new canvas\r\n  var viewport = page.getViewport(1);\r\n  var canvas = document.createElement(\"canvas\");\r\n  canvas.style.display = \"block\";\r\n\r\n  var context = canvas.getContext(\"2d\");\r\n  canvas.height = viewport.height;\r\n  canvas.width = viewport.width;\r\n\r\n  //render page\r\n  page.render({ canvasContext: context, viewport: viewport });\r\n\r\n  //add canvas to body\r\n  document.body.appendChild(canvas);\r\n\r\n  //render new page\r\n  pageNum++;\r\n  if (pdfDoc != null && pageNum <= numPages) {\r\n    pdfDoc.getPage(pageNum).then(handlePages);\r\n    // PDF åŠ è½½å¤±è´¥\r\n  } else {\r\n    console.log(\"pdf load complete\");\r\n    // PDF åŠ è½½å®Œæ¯•ï¼Œbody çš„å†…å®¹å¯ä»¥æ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€æ±‚è¿›è¡Œä¿®æ”¹\r\n    window.webkit.messageHandlers.AppModel.postMessage({\r\n      code: \"00000\",\r\n      msg: \"pdf load complete\",\r\n    }); //å’Œ wkWebView äº¤äº’\r\n  }\r\n}\r\n```\r\n\r\nåœ¨åŸç”Ÿä»£ç ä¸­ï¼Œé€šè¿‡å®ç° `WKScriptMessageHandler` åè®®çš„æ–¹æ³•æ¥æ”¶ `js` ä¼ é€’çš„æ¶ˆæ¯å¹¶å¤„ç†ï¼š\r\n\r\n```objc\r\n- (void)userContentController:(WKUserContentController *)userContentController didReceiveScriptMessage:(WKScriptMessage *)message {\r\n    if ([message.name isEqualToString:@\"AppModel\"]) {\r\n        // å’Œ customview.js æ–‡ä»¶äº¤äº’ï¼Œjs è°ƒ oc çš„ä»£ç \r\n        // æ‰“å°æ‰€ä¼ è¿‡æ¥çš„å‚æ•°ï¼Œåªæ”¯æŒ NSNumber, NSString, NSDate, NSArray, NSDictionary, and NSNull ç±»å‹\r\n        if ([message.body[@\"code\"] isEqualToString:@\"00000\"]) {\r\n            NSLog(@\"%@\", message.body[@\"msg\"]);\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n## å…¼å®¹ iOS8\r\n\r\nåˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»æˆåŠŸåœ¨ `iOS9` åŠä»¥ä¸Šçš„ç³»ç»Ÿä¸­æ‰“å¼€å¸¦æœ‰åŠ å¯†å°ç« çš„ `PDF` æ–‡ä»¶ã€‚\r\n\r\nç„¶è€Œï¼Œåœ¨ `iOS8` ä¸­ï¼Œç”±äºç³»ç»Ÿé™åˆ¶ï¼Œ`PDF` æ–‡ä»¶æ— æ³•æ­£å¸¸åŠ è½½ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è¯¦ç»†è¯´æ˜åŸå› å¹¶æä¾›è§£å†³æ–¹æ¡ˆã€‚\r\n\r\n### åŸå› åˆ†æ\r\n\r\nåœ¨ `iOS9` åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œ`WKWebView` é»˜è®¤æ”¯æŒä» `NSBundle` åŠ è½½ `HTML`ã€`JS` å’Œå…¶ä»–é™æ€èµ„æºã€‚è€Œåœ¨ `iOS8` ä¸­ï¼Œè¿™äº›èµ„æºå¿…é¡»ä½äº `tmp` ç›®å½•æˆ–æ²™ç›’çš„å…¶ä»–å¯å†™è·¯å¾„ä¸­æ‰èƒ½è¢«è®¿é—®ã€‚\r\n\r\n### å…¼å®¹æ–¹æ¡ˆ\r\n\r\nä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬å†³å®š `HTML` å’Œ `JS` æ–‡ä»¶çš„å­˜å‚¨ä½ç½®ã€‚å¦‚æœè¿è¡Œåœ¨ `iOS8` ä¸Šï¼Œæˆ‘ä»¬å°†èµ„æºå¤åˆ¶åˆ° `tmp` ç›®å½•ä¸‹ï¼›å¦åˆ™ï¼Œç›´æ¥ä» `NSBundle` åŠ è½½ã€‚\r\n\r\nä»¥ä¸‹æ˜¯å®Œæ•´çš„å…¼å®¹æ–¹æ¡ˆä»£ç ï¼š\r\n\r\n```objc\r\n- (NSString*)getHtmlBasePath {\r\n    NSString *basePath = @\"\";\r\n    if ([[[UIDevice currentDevice]systemVersion]floatValue]<9.0) {\r\n        basePath = NSTemporaryDirectory();\r\n    }else{\r\n        basePath = [[NSBundle mainBundle] bundlePath];\r\n    }\r\n    return basePath;\r\n}\r\n\r\n- (NSString*)getHtmlPath{\r\n    NSString *path = @\"\";\r\n    if ([[[UIDevice currentDevice]systemVersion] floatValue] < 9.0) {\r\n        path = [self copyHtmlToTemp];\r\n    } else {\r\n        path = [[NSBundle mainBundle] pathForResource:@\"index\" ofType:@\".html\"];\r\n    }\r\n    return path;\r\n}\r\n\r\n//åœ¨ iOS8 ä¸Šï¼Œhtml åŠ js æ–‡ä»¶è¦æ”¾åˆ° tmp ç›®å½•ä¸‹æ‰èƒ½æ­£å¸¸è®¿é—®ï¼ŒiOS9 åŠä»¥ä¸Šä¸ç”¨\r\n- (NSString*)copyHtmlToTemp {\r\n    NSString* htmlPath = [[NSBundle mainBundle] pathForResource:@\"index\" ofType:@\".html\"];\r\n    NSString *compatibilityJSPath = [[NSBundle mainBundle] pathForResource:@\"compatibility\" ofType:@\".js\"];\r\n    NSString *customviewJSPath = [[NSBundle mainBundle] pathForResource:@\"customview\" ofType:@\".js\"];\r\n    NSString *minimalCSSPath = [[NSBundle mainBundle] pathForResource:@\"minimal\" ofType:@\".css\"];\r\n    NSString *pdfJSPath = [[NSBundle mainBundle] pathForResource:@\"pdf\" ofType:@\".js\"];\r\n    NSString *pdfWorkerJSPath = [[NSBundle mainBundle] pathForResource:@\"pdf.worker\" ofType:@\".js\"];\r\n\r\n    NSString *tempPath = NSTemporaryDirectory();\r\n\r\n    NSString *htmlTempPath = [tempPath stringByAppendingPathComponent:@\"index.html\"];\r\n    NSString *compatibilityJSTempPath = [tempPath stringByAppendingPathComponent:@\"compatibility.js\"];\r\n    NSString *customviewJSTempPath = [tempPath stringByAppendingPathComponent:@\"customview.js\"];\r\n    NSString *minimalCSSTempPath = [tempPath stringByAppendingPathComponent:@\"minimal.css\"];\r\n    NSString *pdfJSTempPath = [tempPath stringByAppendingPathComponent:@\"pdf.js\"];\r\n    NSString *pdfWorkerJSTempPath = [tempPath stringByAppendingPathComponent:@\"pdf.worker.js\"];\r\n\r\n    NSFileManager *fm = [NSFileManager defaultManager];\r\n\r\n    if (![fm fileExistsAtPath:htmlTempPath]) {\r\n        [fm copyItemAtPath:htmlPath toPath:htmlTempPath error:nil];\r\n    }\r\n    if (![fm fileExistsAtPath:compatibilityJSTempPath]) {\r\n        [fm copyItemAtPath:compatibilityJSPath toPath:compatibilityJSTempPath error:nil];\r\n    }\r\n    if (![fm fileExistsAtPath:customviewJSTempPath]) {\r\n        [fm copyItemAtPath:customviewJSPath toPath:customviewJSTempPath error:nil];\r\n    }\r\n    if (![fm fileExistsAtPath:minimalCSSTempPath]) {\r\n        [fm copyItemAtPath:minimalCSSPath toPath:minimalCSSTempPath error:nil];\r\n    }\r\n    if (![fm fileExistsAtPath:pdfJSTempPath]) {\r\n        [fm copyItemAtPath:pdfJSPath toPath:pdfJSTempPath error:nil];\r\n    }\r\n    if (![fm fileExistsAtPath:pdfWorkerJSTempPath]) {\r\n        [fm copyItemAtPath:pdfWorkerJSPath toPath:pdfWorkerJSTempPath error:nil];\r\n    }\r\n    return htmlTempPath;\r\n}\r\n```\r\n\r\n## æœ€å\r\n\r\né€šè¿‡æ–‡ä¸­æ‰€è¿°çš„æ–¹æ¡ˆï¼Œæ— è®ºç”¨æˆ·æ˜¯åœ¨ `iOS8` è¿˜æ˜¯æ›´æ–°ç‰ˆæœ¬çš„ç³»ç»Ÿä¸­ï¼Œéƒ½å¯ä»¥é¡ºåˆ©æ‰“å¼€å¸¦æœ‰åŠ å¯†å°ç« çš„ `PDF` æ–‡ä»¶äº†ã€‚\r\n","number":2,"labels":{"nodes":[{"id":"LA_kwDONzrbkM8AAAAB4nYwyw","name":"iOS","url":"https://github.com/onnttf/blog/labels/iOS"}]},"category":{"id":"DIC_kwDONzrbkM4Cmnbf","name":"Show and tell","slug":"show-and-tell","emoji":":raised_hands:","emojiHTML":"<div>ğŸ™Œ</div>"},"author":{"login":"onnttf"},"authorAssociation":"OWNER","createdAt":"2017-08-29T08:00:00Z","updatedAt":"2025-02-03T15:26:17Z","repository":{"id":"R_kgDONzrbkA","url":"https://github.com/onnttf/blog"},"url":"https://github.com/onnttf/blog/discussions/2","jsonFilePath":"discussions/2-D_kwDONzrbkM4AeLb6.json","markdownFilePath":"2017/8/2-D_kwDONzrbkM4AeLb6.md"}
