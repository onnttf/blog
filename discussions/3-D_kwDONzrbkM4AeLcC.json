{"id":"D_kwDONzrbkM4AeLcC","title":"iOS Widget å¼€å‘æŒ‡å—","body":"åœ¨ `iOS` åº”ç”¨ä¸­ï¼Œ`Widget` æ˜¯ä¸€ç§å°å‹çš„åº”ç”¨æ‰©å±•ï¼Œå®ƒå…è®¸ç”¨æˆ·é€šè¿‡è®¾å¤‡çš„é€šçŸ¥ä¸­å¿ƒæˆ–ä¸»å±å¹•ç›´æ¥è®¿é—®åº”ç”¨ä¸­çš„å…³é”®ä¿¡æ¯ã€‚å¼€å‘ä¸€ä¸ª `Widget` éœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„é…ç½®å’Œä»£ç å®ç°ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é€æ­¥ä»‹ç»å¦‚ä½•å¼€å‘ä¸€ä¸ª `Widget`ï¼Œä»è´¦å·é…ç½®åˆ°å®é™…å¼€å‘çš„æ¯ä¸ªæ­¥éª¤ï¼Œå¸®åŠ©ä½ é¡ºåˆ©å®Œæˆå¼€å‘ã€‚\r\n\r\n## è´¦å·é…ç½®\r\n\r\n### ç”³è¯· `GroupID`\r\n\r\n1. åœ¨å¼€å‘è€…è´¦æˆ·ä¸­ï¼Œè¿›å…¥ `App Groups` é…ç½®é¡µ\r\n\r\n   ![image](https://file.onnttf.site/2017/08/29/1.jpeg)\r\n\r\n2. æ ¹æ®é¡µé¢æç¤ºï¼ŒæŒ‰è¦æ±‚å¡«å†™ç›¸å…³ä¿¡æ¯\r\n\r\n   - **`Description`**\r\n\r\n     å¡«å†™è¿™ä¸ª `App Group` çš„æè¿°ã€‚ç¤ºä¾‹ï¼š`Shared Resources for MyApp Widget`\r\n\r\n   - **`ID`**\r\n\r\n     å¡«å†™è¿™ä¸ª `App Group` çš„æ ‡è¯†ï¼Œå»ºè®®ä»¥ `com.{aaa}.{bbb}` å‘½åï¼Œå¡«å†™å®Œæ¯•æ—¶ï¼Œä¼šé»˜è®¤åœ¨å‰é¢åŠ ä¸Š `group`ã€‚ç¤ºä¾‹ï¼š`com.mycompany.myapp`\r\n\r\nå®Œæˆåˆ›å»ºåï¼Œå¦‚å›¾ï¼š\r\n\r\n![image](https://file.onnttf.site/2017/08/29/2.jpeg)\r\n\r\n### å°† `App Group` æ·»åŠ åˆ° `App ID` ä¸­\r\n\r\n1. æ‰“å¼€ä½ çš„ `App ID` é…ç½®é¡µé¢\r\n2. æ‰¾åˆ° `App Groups` é€‰é¡¹ï¼Œå°†ä¹‹å‰åˆ›å»ºçš„ `GroupID` å‹¾é€‰å¯ç”¨\r\n\r\n![image](https://file.onnttf.site/2017/08/29/3.jpeg)\r\n\r\n### é‡æ–°æ¿€æ´» Provisioning Profile\r\n\r\næ“ä½œè¿‡ `App ID` åï¼Œéœ€è¦é‡æ–°æ¿€æ´»æˆ–æ›´æ–°å…³è”çš„ `Provisioning Profile` ä»¥åŒæ­¥æ–°çš„æƒé™ã€‚\r\n\r\n1. åœ¨ `Apple Developer Account` ä¸­æ‰¾åˆ°å¯¹åº”çš„ `Provisioning Profile`\r\n2. ç‚¹å‡» Edit æˆ–é‡æ–°ç”Ÿæˆ\r\n\r\n## é¡¹ç›®é…ç½®\r\n\r\n### App Target é…ç½®\r\n\r\n1. æ‰“å¼€é¡¹ç›®è®¾ç½®ï¼Œè¿›å…¥ `App Target` çš„ `Capabilities` é¡µç­¾\r\n2. æ‰¾åˆ° `App Groups` é€‰é¡¹\r\n3. å‹¾é€‰ä¹‹å‰åˆ›å»ºçš„ `App Group`\r\n\r\n   ![image](https://file.onnttf.site/2017/08/29/5.jpeg)\r\n\r\n### Widget Target é…ç½®\r\n\r\n1. æ‰“å¼€é¡¹ç›®è®¾ç½®ï¼Œè¿›å…¥ `Widget Target` çš„ `General` é¡µç­¾\r\n2. è®¾ç½® `Bundle Identifier`ï¼Œéœ€éµå¾ªä»¥ä¸‹è§„åˆ™\r\n\r\n   - å‰ç¼€å¿…é¡»åŒ…å«ä¸»åº”ç”¨çš„ `Bundle Identifier`\r\n   - åç¼€å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†ä¸èƒ½æ˜¯ `widget`\r\n\r\nç¤ºä¾‹ï¼š\r\n\r\nå¦‚æœä¸»é¡¹ç›®çš„ `Bundle Identifier` æ˜¯ `com.mycompany.myapp`ã€‚é‚£ `Widget` çš„ `Bundle identifier` å¯ä»¥æ˜¯ `com.mycompany.myapp.today`ã€‚\r\n\r\n## å¼€å‘é˜¶æ®µ\r\n\r\nåœ¨å®ŒæˆåŸºç¡€é…ç½®åï¼Œæˆ‘ä»¬è¿›å…¥ `Widget` çš„å¼€å‘é˜¶æ®µã€‚\r\n\r\n### åˆ›å»º Widget Target\r\n\r\n1. åœ¨ä¸»é¡¹ç›®ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„ `Target`ï¼Œé€‰æ‹© `Today Extension`\r\n\r\n   ![image](https://file.onnttf.site/2017/09/07/1.jpeg)\r\n\r\n2. å®Œæˆåä¼šè‡ªåŠ¨ç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶\r\n\r\n   ![image](https://file.onnttf.site/2017/09/07/2.jpeg)\r\n\r\n### ä¿®æ”¹ Widget Target é…ç½®\r\n\r\næŒ‰éœ€å¯¹ `Widget` çš„ `Info.plist` è¿›è¡Œä¿®æ”¹ã€‚\r\n\r\n- ä¿®æ”¹ `Widget` åœ¨é€šçŸ¥æ ä¸­æ˜¾ç¤ºçš„åç§°\r\n\r\n  é€šè¿‡ä¿®æ”¹ `Bundle Display Name` å†…å®¹ï¼Œç»™ `Widget` åç§°è®¾ç½®ä¸€ä¸ªç®€æ´æ˜“æ‡‚çš„åå­—\r\n\r\n- ä½¿ç”¨çº¯ä»£ç å¼€å‘\r\n\r\n  1. åˆ é™¤ `NSExtensionMainStoryboard` é”®å€¼å¯¹ï¼Œå¹¶ç§»é™¤é»˜è®¤ç”Ÿæˆçš„ `MainInterface.storyboard` æ–‡ä»¶\r\n  2. æ·»åŠ  `NSExtensionPrincipalClass` é”®ï¼Œå°†å€¼è®¾ä¸ºä¸»æ§åˆ¶å™¨ç±»åï¼ˆå¦‚ `TodayViewController`ï¼‰\r\n\r\n### å¼€å‘å·¥ä½œ\r\n\r\nåœ¨é…ç½®å®Œæˆä¹‹åï¼Œè¿›å…¥å¼€å‘é˜¶æ®µã€‚`Widget` å¼€å‘ä¸å¤æ‚ï¼Œéµå¾ªæ–‡æ¡£å³å¯å¼€å‘å‡ºç¾è§‚å®ç”¨çš„ `Widget`ï¼Œä½†éœ€è¦ç•™æ„ä¸€äº›ç‰ˆæœ¬å·®å¼‚å’Œç»†èŠ‚é—®é¢˜ã€‚\r\n\r\n#### å…¼å®¹é€‚é…\r\n\r\n##### iOS8\r\n\r\n- æ²¡æœ‰æŠ˜å å’Œå±•å¼€åŠŸèƒ½\r\n- é»˜è®¤ Widget é«˜åº¦ç”± `self.preferredContentSize` æ§åˆ¶\r\n\r\n  ```objc\r\n  self.preferredContentSize = CGSizeMake(kScreenW, 100);\r\n  ```\r\n\r\n- ç»„ä»¶å¸ƒå±€é»˜è®¤å‘å³åç§» 30 å•ä½ï¼Œå¯ä»¥é€šè¿‡ `widgetMarginInsetsForProposedMarginInsets` æ–¹æ³•è¿›è¡Œè°ƒæ•´\r\n\r\n  ```objc\r\n  - (UIEdgeInsets)widgetMarginInsetsForProposedMarginInsets:(UIEdgeInsets)defaultMarginInsets {\r\n     return UIEdgeInsetsMake(0, 0, 0, 0);\r\n  }\r\n  ```\r\n\r\n##### iOS 10 åŠä¹‹å\r\n\r\n- `Widget` æ”¯æŒäº†ä¸¤ç§æ˜¾ç¤ºæ¨¡å¼\r\n\r\n  - NCWidgetDisplayModeCompact\r\n\r\n    é«˜åº¦å›ºå®šï¼Œæœ€ä½é«˜åº¦ä¸º `110`\r\n\r\n  - NCWidgetDisplayModeExpanded\r\n\r\n    é«˜åº¦å¯å˜\r\n\r\n- è®¾ç½®æ˜¾ç¤ºæ¨¡å¼\r\n\r\n  **éœ€è¦åœ¨è®¾å®š `Size` å‰è®¾å®šè¿™ä¸ªå±æ€§**\r\n\r\n  ```objc\r\n  - (void)viewDidLoad {\r\n      [super viewDidLoad];\r\n      if ([[UIDevice currentDevice] systemVersion].intValue >= 10) {\r\n          self.extensionContext.widgetLargestAvailableDisplayMode = NCWidgetDisplayModeCompact; // æˆ– NCWidgetDisplayModeExpanded\r\n      }\r\n      self.preferredContentSize = CGSizeMake(kScreenW, 100);\r\n      [self setupUI];\r\n  }\r\n  ```\r\n\r\n- ç›‘å¬æ˜¾ç¤ºæ¨¡å¼å˜åŒ–\r\n\r\n  å½“æ˜¾ç¤ºæ¨¡å¼è®¾ç½®ä¸º `NCWidgetDisplayModeExpanded` æ—¶ï¼Œç‚¹å‡»æŠ˜å å’Œæ‰“å¼€æ—¶ï¼Œä¼šè§¦å‘ä¸‹é¢è¿™ä¸ªæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å¯ä»¥ä¿®æ”¹å¯¹åº”çŠ¶æ€çš„é«˜åº¦ã€‚ä¿®æ”¹å®Œæ¯•åï¼Œæ›´æ–°è§†å›¾å³å¯çœ‹åˆ°æœ€æ–°çš„å¸ƒå±€ã€‚\r\n\r\n  ```objc\r\n  - (void)widgetActiveDisplayModeDidChange:(NCWidgetDisplayMode)activeDisplayMode withMaximumSize:(CGSize)maxSize {\r\n      if (activeDisplayMode == NCWidgetDisplayModeCompact) {\r\n          self.preferredContentSize = CGSizeMake(maxSize.width, 110);\r\n      } else {\r\n          self.preferredContentSize = CGSizeMake(maxSize.width, 200);\r\n      }\r\n   }\r\n\r\n   //åœ¨ä¸‹é¢çš„æ–¹æ³•ä¸­æ›´æ–°è§†å›¾\r\n   -(void)widgetPerformUpdateWithCompletionHandler:(void (^)(NCUpdateResult))completionHandler {\r\n   //    NCUpdateResultNewData   æ–°çš„å†…å®¹éœ€è¦é‡æ–°ç»˜åˆ¶è§†å›¾\r\n   //    NCUpdateResultNoData    éƒ¨ä»¶ä¸éœ€è¦æ›´æ–°\r\n   //    NCUpdateResultFailed    æ›´æ–°è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯\r\n     completionHandler(NCUpdateResultNoData);\r\n   }\r\n  ```\r\n\r\n#### ä»£ç å…±äº«\r\n\r\nå¸¸ç”¨çš„å››ç§ä»£ç å…±äº«æ–¹æ³•ï¼š\r\n\r\n1. å°†ä»£ç æ‰“åŒ…æˆ `Framework`ï¼Œç„¶å `link` åˆ°ä¸» `App`å’Œ `Widget` ä¸­ **ï¼ˆæ¨èï¼‰**\r\n2. ä¸æ€•å®‰è£…åŒ…å˜å¤§çš„è¯ï¼Œå¯ä»¥è€ƒè™‘å°†éœ€è¦çš„ç¬¬ä¸‰æ–¹åº“åœ¨ä¸» `App` å’Œ `Widget` ä¸­åˆ†åˆ«å¤åˆ¶ä¸€ä»½ **ï¼ˆæ¨èï¼‰**\r\n3. å°†éœ€è¦å…±äº«çš„æ–‡ä»¶æŒ‰å›¾ä¸­è¿›è¡Œå‹¾é€‰é…ç½®\r\n\r\n   ![image](https://file.onnttf.site/2017/09/07/4.jpeg)\r\n\r\n4. é€šè¿‡ `Pods` å¯¼å…¥ï¼Œä¸å¤ªå»ºè®®é€šè¿‡ `Pods` åˆ†åˆ«å‘ä¸¤ä¸ª `Target` ä¸­å¯¼å…¥ç¬¬ä¸‰æ–¹åº“ï¼Œå› ä¸ºå¾ˆå®¹æ˜“å‘ç”Ÿä¸€äº›ä¸å¥½å¤„ç†çš„é—®é¢˜\r\n\r\n#### æ•°æ®å…±äº«\r\n\r\nå¸¸ç”¨çš„ä¸¤ç§æ•°æ®å…±äº«æ–¹æ³•ï¼š\r\n\r\n1. NSUserDefaults\r\n\r\n   å’Œæˆ‘ä»¬å¸¸ç”¨çš„æ–¹æ³•ä¸€æ ·ï¼Œä¸è¿‡åœ¨åˆ›å»º `NSUserDefaults` æ—¶ï¼Œéœ€è¦å¡«å†™æˆ‘ä»¬ä¹‹å‰çš„ `GroupID`ã€‚é€šè¿‡ `GroupID`ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œä¸» `App` å’Œ `Widget` ä¹‹é—´çš„æ•°æ®å…±äº«äº†ã€‚\r\n\r\n   ```objc\r\n   // å†™å…¥æ•°æ®\r\n   NSString *groupID = @\"group.com.aaa.bbb\";\r\n   NSUserDefaults *ud = [[NSUserDefaults alloc] initWithSuiteName:groupID];[ud setObject:@\"æˆ‘æ˜¯æµ‹è¯•çš„æ•°æ®\" forKey:@\"test\"];\r\n   [ud synchronize];\r\n\r\n   // è¯»å–æ•°æ®\r\n   NSString *groupID = @\"group.com.aaa.bbb\";\r\n   NSUserDefaults *ud = [[NSUserDefaults alloc] initWithSuiteName:groupID];\r\n   NSString *value = [ud objectForKey:@\"test\"];\r\n   ```\r\n\r\n2. NSFileManager\r\n\r\n   ```objc\r\n   // å†™å…¥æ•°æ®\r\n   NSString *groupID = @\"group.com.aaa.bbb\";\r\n   NSError *err = nil;\r\n   NSURL *containerURL = [[NSFileManager defaultManager] containerURLForSecurityApplicationGroupIdentifier:groupID];\r\n   containerURL = [containerURL URLByAppendingPathComponent:@\"Library/Caches/test\"];\r\n   NSString *value = @\"æˆ‘æ˜¯æµ‹è¯•çš„æ•°æ®\";\r\n   BOOL result = [value writeToURL:containerURL atomically:YES encoding:NSUTF8StringEncoding error:&err];\r\n   if(result){\r\n       NSLog(@\"å†™å…¥æˆåŠŸ\");\r\n   }\r\n\r\n   // è¯»å–æ•°æ®\r\n   NSString *groupID = @\"group.com.aaa.bbb\";\r\n   NSError *err = nil;\r\n   NSURL *containerURL = [[NSFileManager defaultManager] containerURLForSecurityApplicationGroupIdentifier:groupID];\r\n   containerURL = [containerURL URLByAppendingPathComponent:@\"Library/Caches/test\"];\r\n   NSString *value = [NSString stringWithContentsOfURL:containerURL encoding:NSUTF8StringEncoding error:&err];\r\n   ```\r\n\r\n#### æ•°æ®åˆ·æ–°\r\n\r\n- `Widget` ä»å±å¹•ä¸Šæ¶ˆå¤± 2s å·¦å³åï¼Œå†æ¬¡å‡ºç°åœ¨å±å¹•ä¸­æ—¶ï¼Œä¼šæ‰§è¡Œ `viewDidLoad` æ–¹æ³•\r\n- `Widget` åœ¨çŸ­æ—¶é—´å†…é¢‘ç¹åœ°æ¶ˆå¤±æ˜¾ç¤ºï¼Œä¼šæ‰§è¡Œ `viewWillAppear` æ–¹æ³•\r\n\r\nå¦‚æœéœ€è¦åˆ·æ–°æ•°æ®ï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚åœ¨ä¸åŒçš„æ–¹æ³•ä¸­è·å–æœ€æ–°æ•°æ®ã€‚\r\n\r\n#### æ‰“å¼€ App\r\n\r\n1. è®¾ç½® `App` çš„ `URLSchemes`ï¼Œæ‰“å¼€ `APP` ä¸»è¦é€šè¿‡ `URLScheme` æ‰“å¼€å’Œä¼ é€’å‚æ•°å€¼ã€‚è®¾ç½® `URLSchemes` æ—¶ï¼Œè¦ç‹¬ç‰¹ä¸€äº›ï¼Œé¿å…ä¸å…¶ä»– `App` é‡å¤\r\n   ![image](https://file.onnttf.site/2017/09/07/5.jpeg)\r\n2. åœ¨ `Widget` ä¸­æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºè§¦å‘æ‰“å¼€ `App` çš„æ“ä½œå’Œä¼ é€’å‚æ•°\r\n\r\n   ```objc\r\n   NSString *schemeString = @\"test_scheme://actionName?paramName=paramValue\";\r\n   [self.extensionContext openURL:[NSURL URLWithString:schemeString] completionHandler:^(BOOL success) {\r\n\r\n   }];\r\n   ```\r\n\r\n3. `Appdelegate` çš„ä»£ç†æ–¹æ³•ä¸­ï¼Œæˆªå– `URL`ï¼Œåšå“åº”å¤„ç†ï¼š\r\n\r\n   ```objc\r\n    // æ‰€æœ‰ç‰ˆæœ¬çš„éƒ½å¯ä»¥ä½¿ç”¨\r\n    - (BOOL)application:(UIApplication *)application openURL:(NSURL *)url sourceApplication:(NSString *)sourceApplication annotation:(id)annotation {\r\n        [self appCallbackWithOpenUrl:url];\r\n        return YES;\r\n    }\r\n\r\n    // iOS 8 ä»¥å\r\n    - (BOOL)application:(UIApplication *)app openURL:(NSURL *)url options:(NSDictionary<UIApplicationOpenURLOptionsKey, id> *)options {\r\n        [self appCallbackWithOpenUrl:url];\r\n        return YES;\r\n    }\r\n\r\n    // iOS 7\r\n    - (BOOL)application:(UIApplication *)application handleOpenURL:(NSURL *)url {\r\n        [self appCallbackWithOpenUrl:url];\r\n        return YES;\r\n    }\r\n\r\n    - (void)appCallbackWithOpenUrl:(NSURL *)url{\r\n        NSLog(@\"url: %@\", url.host);\r\n        // é’ˆå¯¹ url è¿›è¡Œä¸åŒçš„æ“ä½œ\r\n    }\r\n   ```\r\n\r\n## æœ€å\r\n\r\néšç€ `iOS` ç”Ÿæ€çš„æŒç»­å‘å±•ï¼Œ`Widget` ä¸ä»…æ‰©å±•äº†åº”ç”¨çš„åŠŸèƒ½ï¼Œè¿˜ä¸ºç”¨æˆ·æä¾›äº†æ›´åŠ ç›´è§‚å’Œä¾¿æ·çš„äº’åŠ¨æ–¹å¼ã€‚\r\n\r\né€šè¿‡åˆç†åˆ©ç”¨ `Widget`ï¼Œå¼€å‘è€…èƒ½å¤Ÿæå‡åº”ç”¨çš„ç”¨æˆ·ä½“éªŒï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿå¿«é€Ÿè®¿é—®é‡è¦ä¿¡æ¯ï¼Œå¹¶é€šè¿‡äº’åŠ¨æ›´åŠ æµç•…åœ°ä¸åº”ç”¨è¿›è¡Œè¿æ¥ã€‚\r\n","number":3,"labels":{"nodes":[{"id":"LA_kwDONzrbkM8AAAAB4nYwyw","name":"iOS","url":"https://github.com/onnttf/blog/labels/iOS"}]},"category":{"id":"DIC_kwDONzrbkM4Cmnbf","name":"Show and tell","slug":"show-and-tell","emoji":":raised_hands:","emojiHTML":"<div>ğŸ™Œ</div>"},"author":{"login":"onnttf"},"authorAssociation":"OWNER","createdAt":"2017-08-29T08:00:00Z","updatedAt":"2025-02-03T15:27:41Z","repository":{"id":"R_kgDONzrbkA","url":"https://github.com/onnttf/blog"},"url":"https://github.com/onnttf/blog/discussions/3","jsonFilePath":"discussions/3-D_kwDONzrbkM4AeLcC.json","markdownFilePath":"2017/08/3-D_kwDONzrbkM4AeLcC.md"}
