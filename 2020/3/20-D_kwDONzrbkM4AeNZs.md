# 如何保持 SSH 服务不掉线

在日常工作中，保持 `SSH` 服务不掉线是一个非常重要的需求。常见保持 `SSH` 服务不掉线的方法有两种：

1. 服务端发送心跳包
2. 客户端发送心跳包

这两种方案都能有效解决 `SSH` 连接断开的问题。接下来，我们将深入探讨这两种方案的具体配置方法。

## 服务端发送心跳包

1. 登录服务器后，打开配置文件

   ```bash
   sudo vim /etc/ssh/sshd_config
   ```

2. 检查并配置心跳包相关参数

   1. 找到以下两个关键配置项（如有 `#`，需要去掉）

      - `ClientAliveInterval` - 控制服务器向客户端发送心跳包的时间间隔
      - `ClientAliveCountMax` - 设置心跳包检测失败的最大重试次数

   2. 推荐的参数配置

      ```ini
      # 每 30 秒发送一次心跳包检测，可以及时发现连接异常
      ClientAliveInterval 30
      # 允许连续 3 次心跳包失败，在网络波动时仍保持稳定
      ClientAliveCountMax 3
      ```

3. 保存配置文件

   - 按 `ESC` 键退出编辑模式
   - 输入 `:wq` 保存文件并退出
   - 如遇到权限问题，使用 `:w!` 强制保存

4. 重启 `SSH` 服务应用新配置

   ```bash
   sudo systemctl restart ssh
   ```

> 核心参数详解：
>
> **ClientAliveInterval**
>
> - 功能：服务器定时发送心跳包检测客户端是否存活
> - 单位：秒（s）
> - 默认：`0`（禁用）
> - 建议：`30` 秒（平衡性能与及时性）
> - 说明：超过设定时间未收到客户端响应，则发送心跳包
>
> **ClientAliveCountMax**
>
> - 功能：允许心跳检测失败的最大次数
> - 默认：`3`
> - 建议：`3` 次（可靠性与资源消耗的最佳平衡）
> - 作用：防止临时网络波动造成连接断开
> - 说明：实际最大超时时间 = 间隔 × 次数

## 客户端发送心跳包

1. 进入客户端的 `SSH` 配置目录

   ```bash
   cd ~/.ssh/
   ```

2. 打开配置文件

   ```bash
   vim config
   ```

3. 添加以下心跳配置参数并保存

   ```ini
   # 配置客户端每 30 秒发送一次心跳包
   ServerAliveInterval 30
   # 允许最多 120 次重试
   ServerAliveCountMax 120
   ```

4. 保存并退出

   - 按 `ESC` 键退出编辑模式
   - 输入 `:wq` 保存并退出

> 核心参数说明：
>
> **ServerAliveInterval**
>
> - 功能：客户端向服务器发送心跳的时间间隔
> - 单位：秒（s）
> - 默认值：`0`（表示禁用）
> - 建议值：`20-60` 秒
> - 注意：设置过小会增加服务器负载
>
> **ServerAliveCountMax**
>
> - 功能：客户端允许心跳检测失败的最大次数
> - 默认值：`3`
> - 建议值：根据需要设置，通常 `100-999`
> - 说明：实际最大保持时间 = 间隔 × 次数

## 如何选择最佳方案

两种方案各有优势，选择哪种主要取决于您的具体使用场景：

- **一台服务器连接多个客户端**

  推荐服务端心跳方案，只需在服务器配置一次，对所有客户端生效

- **一台客户端连接多台服务器**

  推荐客户端心跳方案，只需在客户端配置一次，对所有服务器连接生效
